
# --- Build Stage: Node for assets ---
FROM node:20-alpine as build-assets
WORKDIR /app
COPY package*.json ./
COPY resources/ ./resources/
COPY vite.config.js ./
RUN npm install && npm run build

# --- Final Stage: PHP-Nginx ---
FROM trafex/php-nginx:latest
USER root
RUN apk --no-cache add \
	php84-pdo \
	php84-pdo_pgsql \
	php84-pgsql \
	php84-iconv \
	postgresql-dev

# Copy custom nginx configuration
COPY nginx.conf /etc/nginx/conf.d/default.conf


# Copy composer files first for better caching
COPY composer.json composer.lock ./
# Copy application code (except node_modules)
COPY . .
# Install composer and dependencies
RUN apk --no-cache add curl git && \
	curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer && \
	composer install --no-dev --optimize-autoloader
COPY --from=build-assets /app/public/build ./public/build
# Set permissions for Laravel writable directories
RUN chown -R nobody:nobody storage bootstrap/cache && \
	chmod -R ug+rwx storage bootstrap/cache
USER nobody
